# Alert policies for Spooky Labs infrastructure
# These will be created via gcloud commands

# High Error Rate Alert
alert_policies:
  - displayName: "High Error Rate - Cloud Functions"
    documentation:
      content: "Cloud Functions are experiencing high error rates"
      mimeType: "text/markdown"
    conditions:
      - displayName: "Error rate above 5%"
        conditionThreshold:
          filter: 'resource.type="cloud_function" AND metric.type="cloudfunctions.googleapis.com/function/execution_count"'
          comparison: "COMPARISON_GREATER_THAN"
          thresholdValue: 0.05
          duration: "300s"
          aggregations:
            - alignmentPeriod: "60s"
              perSeriesAligner: "ALIGN_RATE"
              crossSeriesReducer: "REDUCE_MEAN"
              groupByFields:
                - "resource.label.function_name"
    alertStrategy:
      autoClose: "1800s"
    combiner: "OR"

  - displayName: "GKE High CPU Usage"
    documentation:
      content: "Kubernetes pods are using high CPU"
      mimeType: "text/markdown"
    conditions:
      - displayName: "CPU usage above 80%"
        conditionThreshold:
          filter: 'resource.type="k8s_container" AND resource.label.namespace_name="paper-trading" AND metric.type="kubernetes.io/container/cpu/core_usage_time"'
          comparison: "COMPARISON_GREATER_THAN"
          thresholdValue: 0.8
          duration: "300s"
          aggregations:
            - alignmentPeriod: "60s"
              perSeriesAligner: "ALIGN_RATE"
              crossSeriesReducer: "REDUCE_MEAN"
              groupByFields:
                - "resource.label.pod_name"
    combiner: "OR"

  - displayName: "BigQuery High Slot Usage"
    documentation:
      content: "BigQuery is using too many slots - potential cost issue"
      mimeType: "text/markdown"
    conditions:
      - displayName: "Slot usage above 1000"
        conditionThreshold:
          filter: 'resource.type="bigquery_project" AND metric.type="bigquery.googleapis.com/slots/total_allocated"'
          comparison: "COMPARISON_GREATER_THAN"
          thresholdValue: 1000
          duration: "600s"
          aggregations:
            - alignmentPeriod: "60s"
              perSeriesAligner: "ALIGN_MEAN"
              crossSeriesReducer: "REDUCE_MAX"
    combiner: "OR"

  - displayName: "Daily Cost Budget Alert"
    documentation:
      content: "Daily spending is approaching budget limits"
      mimeType: "text/markdown"
    conditions:
      - displayName: "Daily cost above $20"
        conditionThreshold:
          filter: 'metric.type="billing.googleapis.com/billing/total_cost"'
          comparison: "COMPARISON_GREATER_THAN"
          thresholdValue: 20.0
          duration: "3600s"
          aggregations:
            - alignmentPeriod: "86400s"
              perSeriesAligner: "ALIGN_SUM"
              crossSeriesReducer: "REDUCE_SUM"
    combiner: "OR"

  - displayName: "Paper Trading Pod Failures"
    documentation:
      content: "Paper trading pods are failing or restarting frequently"
      mimeType: "text/markdown"
    conditions:
      - displayName: "Pod restart rate too high"
        conditionThreshold:
          filter: 'resource.type="k8s_container" AND resource.label.namespace_name="paper-trading" AND metric.type="kubernetes.io/container/restart_count"'
          comparison: "COMPARISON_GREATER_THAN"
          thresholdValue: 3
          duration: "600s"
          aggregations:
            - alignmentPeriod: "300s"
              perSeriesAligner: "ALIGN_RATE"
              crossSeriesReducer: "REDUCE_MAX"
              groupByFields:
                - "resource.label.pod_name"
    combiner: "OR"

  - displayName: "FMEL Data Pipeline Failure"
    documentation:
      content: "FMEL data is not being recorded properly"
      mimeType: "text/markdown"
    conditions:
      - displayName: "No FMEL data in 30 minutes"
        conditionAbsent:
          filter: 'resource.type="bigquery_table" AND resource.label.table_id="decisions" AND metric.type="bigquery.googleapis.com/storage/uploaded_bytes"'
          duration: "1800s"
          aggregations:
            - alignmentPeriod: "300s"
              perSeriesAligner: "ALIGN_RATE"
              crossSeriesReducer: "REDUCE_SUM"
    combiner: "OR"